# 前言

> 本篇文章通过对MySQL的基本**逻辑**原理和索引原理的回顾,掌握相关的实战优化手段

# 原理

## sql基本原理

### 查询

当执行select *  from t_id where id = 1,它的内部过程是怎样的呢?

通过下面一张图,整体了解一下

![image-20200217155424944](assets/MySQL%E5%8E%9F%E7%90%86%E5%92%8C%E5%B8%B8%E7%94%A8%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5/image-20200217155424944.png)

### 构成

#### MySQL客户端/服务端通信协议

> MySQL客户端和服务器之间的通信协议是“半双工”的,这意味着,在任何一个时刻,要么是由服务器向客户端发送数据,要么是由客户端向服务器发送数据,这两个动作不能同时发生。所以,我们无法也无须将一个消息切成小块独立来发送。

优点: 这种协议让MySQL通讯简单迅速 

缺点: 没法进行流量控制,一旦一端发送消息,另一端要接收完整个消息才能进行相应;所以一但客户端发送了请求,能做的只能等待,表面上看似是客户端从服务端拉数据,本质上是MySQL在往客户端推送数据,此时的客户端像是**从消防水管喝水**一样,只能等水管停水

#### 连接器

说到连接大家看到不陌生,通过可视化工具或者下面的连接命令

```shell
mysql -h 127.0.0.1 -u root -p -P 3306
```

然后会提示输入密码

如果用户名或密码不对,你就会收到一个"Access denied for user"的错误,如果认证通过,当前连接就会出现在processlist表里

![image-20200217162030475](assets/MySQL%E5%8E%9F%E7%90%86%E5%92%8C%E5%B8%B8%E7%94%A8%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5/image-20200217162030475.png)

Sleep代表是一个空闲连接,太长时间没动静(默认8h),连接器会断开这个连接;当连接被断开之后,客户端发送请求,会收到

Lost connection to MySQL server during query 这时候如果你要继续,就需要重连,然后再执行请求了

建立连接过程通常是比较复杂的,我们可以减少短连接,尽量使用长连接;

如果全部使用长连接,肯定会带来内存暴涨的问题,因为MySQL在执行过程中临时内存是管理在连接对象里面的,只有连接断开才会释放;

如何解决这种问题?

- 1.定期断开长连接,避免内存占用过大

- 2.MySQL 5.7+版本,可以在每次执行一个比较大的操作后,通过执行 mysql_reset_connection来重新初始化连接资源.这个过程不需要重连和重新做权限验证,但是会将连接恢复到刚刚创建完时的状态。

#### 查询缓存

拥有连接我们就可以执行select语句了,这时会先去查询缓存,查查之前是否执行过该语句,执行过就将该语句查询的结果直接返回;

**通常来说不要使用查询缓存,因为大多数情况没什么用**

因为缓存很容易被情况,只要发生表的更新,该表上的缓存会被清空,这样就会导致我们的缓存命中率很低;除非我们的表是一张静态表,很久才会更新,比如系统配置

所以建议将**query_cache_type**设置成**DEMAND**,默认的sql查询都不会使用查询缓存;可以用**SQL_CACHE**显示进行查询

```shell
select SQL_CACHE *from t_id where id = 1;
```

刚准备掌握这个技巧的时候,控制台输出却很差强人意的提醒你,这个要被废弃,后续的高版本(**MySQL 5.8+**),缓存模块要被删掉

![image-20200217164642051](assets/MySQL%E5%8E%9F%E7%90%86%E5%92%8C%E5%B8%B8%E7%94%A8%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5/image-20200217164642051.png)

所以大家对于缓存模块了解一下就好, 毕竟缓存优化思想在我们日常业务工作中是很常用的,MySQL删除这个优化,也是无奈之举

#### 分析器

没有命中缓存(或者说后面没有缓存了),此时需要进行SQL语句解析

分析器先会做"词法分析",MySQL需要识别出你的sql字符串 分别代表什么;

比如你是select * from t_id where id = 1语句,MySQL会识别这是一个查询语句,字符串t_id被识别成表名t_id,id被识别成"列id";

词法分析后,开始做语法分析,说白了就是校验你的SQL是否满足MySQL语法;如果语句有问题,就会收到**You have an error in your SQL syntax**的善意提醒

#### 优化器

你的sql通过了分析器,MySQL知道你要干什么了,但是具体怎么做,究竟决定你是坐拖拉机还是要坐飞机,优化器会进行抉择较优的方案,至于通常优化器怎么选择,会在索引里面体现;

#### 执行器

分析器分析了你要干啥,优化器知道了怎么做更好,那么进入执行器阶段,就要执行语句了;执行前会进行权限校验,如果有权限,就会打开表继续执行,打开表就会根据表的引擎定义,去使用这个引擎提供的api

#### 存储引擎



### 日志系统

> 当进行增删改操作的时候,就不得不提MySQL的日志系统

这里以update语句为例

### 事务隔离

## 索引原理



# 优化手段

> 当了解了sql的执行原理,各个部分的组成,我们才能更好的从对应的地方进行优化

# 技术总结



# 参考

- 高性能MySQL第三版
- 极客时间MySQL核心45讲

# END